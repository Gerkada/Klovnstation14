# SPDX-FileCopyrightText: 2025 LaCumbiaDelCoronavirus
#
# SPDX-License-Identifier: MPL-2.0

# Every once in a while, this POSTs the KS14 watchdog server to ask it to update with latest repo master.

name: Watchdog Update Request

on:
  schedule:
    # runs every day at 18:00 UTC
    - cron: '0 0 * * *'

  # run on push to master (disabled)
  # push:
  #   branches: [ master ]

  # allow manual triggering
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    # Ip and port arent really that secret but whatever.
    steps:
    - name: Send POST update request to watchdog
      # Output of curl is hidden and we only say if something ever happened or nothing ever happened (as usual).
      run: |
        if curl -s -f -o /dev/null \
            -v \
            -X POST \
            -u ${{ vars.WATCHDOG_INSTANCE_NAME }}:${{ secrets.WATCHDOG_INSTANCE_API_TOKEN }} \
            "http://${{ secrets.WATCHDOG_IP_AND_PORT }}/instances/${{ vars.WATCHDOG_INSTANCE_NAME }}/update"; then
          echo "Update request was successfully sent. This is not indicative of whether or not the server actually cares."
        else
          echo "Update request failed to sent. This is not indicative of whether or not the server actually cares."
          exit 1
        fi
